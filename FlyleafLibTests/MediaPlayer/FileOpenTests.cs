using System.Windows;
using FluentAssertions;
using FluentAssertions.Execution;
using Xunit;

namespace FlyleafLib.MediaPlayer;

/// <summary>
/// Integration tests for File open functionality.
/// Tests verify configuration readiness for file opening and required subsystem presence.
/// </summary>
[Collection("WPF Application Collection")]
public class FileOpenTests
{
    [Fact]
    public void FileOpen_Positive_ConfigReadyForFileOpen()
    {
        // Arrange
        var config = new Config(true);
        var player = new Player(config);

        // Act & Assert
        using (new AssertionScope())
        {
            // Verify configuration is properly initialized and ready
            config.Should().NotBeNull("Config should be initialized");
            player.Config.Should().BeSameAs(config, "Player should reference the provided config");

            // Verify config subsections are ready for file operations
            config.Audio.Should().NotBeNull("Audio config should be initialized");
            config.Video.Should().NotBeNull("Video config should be initialized");
            config.Subtitles.Should().NotBeNull("Subtitles config should be initialized");
            config.Demuxer.Should().NotBeNull("Demuxer config should be initialized");
            config.Decoder.Should().NotBeNull("Decoder config should be initialized");
            config.Player.Should().NotBeNull("Player config should be initialized");

            // Verify config has default enabled states for file opening
            config.Audio.Enabled.Should().BeTrue("Audio should be enabled for file opening");
            config.Video.Enabled.Should().BeTrue("Video should be enabled for file opening");
            config.Subtitles.Enabled.Should().BeTrue("Subtitles should be enabled for file opening");

            // Verify player status is ready to accept file open commands
            player.Status.Should().Be(Status.Stopped, "Player should be in Stopped status, ready for file open");
            player.IsDisposed.Should().BeFalse("Player should not be disposed");

            // Verify decoder context is initialized and ready
            player.decoder.Should().NotBeNull("Decoder context should be ready for file opening");

            // Verify playlist is available for file operations
            player.Playlist.Should().NotBeNull("Playlist should be initialized");
        }

        // Cleanup
        player.Dispose();
    }

    [Fact]
    public void FileOpen_Negative_RequiredStructuresPresentOrNotNull()
    {
        // Arrange
        var config = new Config(true)
        {
            // Disable all subsystems to test that structures are still present
            Audio = { Enabled = false },
            Video = { Enabled = false },
            Subtitles = { Enabled = false }
        };

        // Act
        var player = new Player(config);

        // Assert
        using (new AssertionScope())
        {
            // Even with all subsystems disabled, structures should still be present (not null)
            player.Audio.Should().NotBeNull("Audio structure should be present even when disabled");
            player.Video.Should().NotBeNull("Video structure should be present even when disabled");
            player.Subtitles.Should().NotBeNull("Subtitles structure should be present even when disabled");

            // Verify decoders are still initialized
            player.AudioDecoder.Should().NotBeNull("AudioDecoder structure should be present");
            player.VideoDecoder.Should().NotBeNull("VideoDecoder structure should be present");
            player.SubtitlesDecoders.Should().NotBeNull("SubtitlesDecoders structure should be present");

            // Verify demuxers are still initialized
            player.AudioDemuxer.Should().NotBeNull("AudioDemuxer structure should be present");
            player.VideoDemuxer.Should().NotBeNull("VideoDemuxer structure should be present");
            player.SubtitlesDemuxers.Should().NotBeNull("SubtitlesDemuxers structure should be present");
            // Note: MainDemuxer is null until media is opened

            // Verify decoder context is present
            player.decoder.Should().NotBeNull("Decoder context should be present even with disabled subsystems");

            // Verify essential components are not null
            player.Config.Should().NotBeNull("Config should always be present");
            player.Commands.Should().NotBeNull("Commands should be present");
            player.Activity.Should().NotBeNull("Activity should be present");
            player.Data.Should().NotBeNull("Data should be present");

            // Verify the structures are not opened (since they're disabled)
            player.Audio.IsOpened.Should().BeFalse("Audio should not be opened when disabled");
            player.Video.IsOpened.Should().BeFalse("Video should not be opened when disabled");
            player.Subtitles[0].IsOpened.Should().BeFalse("Subtitles should not be opened when disabled");

            // Verify player can still be disposed properly even with disabled subsystems
            player.IsDisposed.Should().BeFalse("Player should not be disposed yet");
        }

        // Cleanup - verify disposal works even with all subsystems disabled
        player.Dispose();
        player.IsDisposed.Should().BeTrue("Player should be disposed after Dispose() call");
    }
}
